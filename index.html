<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n T√©cnica - CoRheSelect</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .logo { font-size: 48px; margin-bottom: 10px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .info-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 14px; margin-top: 10px; }
        .hidden { display: none !important; }
        .timer-warning { color: #ed8936 !important; animation: pulse 1s infinite; }
        
        /* Welcome Screen */
        #welcomeScreen { padding: 40px; }
        .welcome-intro { background: #f7fafc; border-left: 4px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-item { background: #f7fafc; padding: 16px; border-radius: 8px; }
        .info-icon { font-size: 24px; margin-bottom: 8px; }
        .info-label { font-size: 14px; color: #718096; margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; color: #2d3748; }
        
        /* Privacy Notice */
        .privacy-notice { background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .privacy-notice h3 { color: #d68910; margin-bottom: 10px; font-size: 18px; }
        .privacy-notice ul { margin-left: 20px; }
        .privacy-notice li { margin: 5px 0; color: #7d6608; }
        
        /* Instructions */
        .instructions { background: #fff; padding: 20px; margin: 20px 0; border-radius: 8px; border: 2px solid #e2e8f0; }
        .instructions h3 { color: #2d3748; margin-bottom: 15px; }
        .instructions ul { margin-left: 20px; }
        .instructions li { margin: 8px 0; color: #4a5568; }
        .instructions strong { color: #667eea; }
        
        .start-button { background: #667eea; color: white; border: none; padding: 16px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-top: 20px; width: 100%; transition: all 0.3s; }
        .start-button:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        
        /* Question Screen */
        #questionContainer { padding: 40px; }
        .progress-container { background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden; margin-bottom: 30px; }
        .progress-bar { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .question-number { font-size: 18px; color: #4a5568; font-weight: 600; }
        .timer { font-size: 18px; color: #667eea; font-weight: 600; }
        .question-text { font-size: 24px; color: #2d3748; margin-bottom: 30px; line-height: 1.5; }
        
        /* Technical Question (Multiple Choice) */
        .options-container { display: flex; flex-direction: column; gap: 15px; }
        .option { background: #f7fafc; border: 2px solid #e2e8f0; padding: 20px; border-radius: 10px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; }
        .option:hover { border-color: #667eea; background: #edf2f7; }
        .option.selected { border-color: #667eea; background: #edf2f7; }
        .option-radio { margin-right: 15px; }
        .option-text { font-size: 16px; color: #2d3748; }
        
        /* Video Question */
        .video-container { text-align: center; }
        .video-preview { width: 100%; max-width: 640px; height: 480px; background: #000; border-radius: 10px; margin: 20px auto; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .video-preview video { width: 100%; height: 100%; object-fit: cover; }
        .video-placeholder { color: #fff; font-size: 18px; }
        .video-controls { margin: 20px 0; }
        .video-info { background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; }
        .video-info p { margin: 5px 0; color: #4a5568; }
        .attempt-indicator { display: inline-block; background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; margin: 10px 0; }
        
        /* Buttons */
        .button-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-primary:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #2d3748; }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; }
        
        .next-button { background: #48bb78; color: white; border: none; padding: 16px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-top: 30px; width: 100%; transition: all 0.3s; }
        .next-button:hover { background: #38a169; }
        .next-button:disabled { background: #cbd5e0; cursor: not-allowed; }
        
        /* Loading */
        #loadingScreen { padding: 60px 40px; text-align: center; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        
        /* Results */
        #resultsScreen { padding: 40px; text-align: center; }
        .success-icon { font-size: 64px; margin-bottom: 20px; }
        .results-title { font-size: 28px; color: #2d3748; margin-bottom: 10px; }
        .results-message { font-size: 18px; color: #718096; margin-bottom: 30px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Camera Permission */
        .camera-permission { background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center; }
        .camera-permission p { color: #7d6608; margin: 10px 0; }
        
        /* Recording indicator */
        .recording-indicator { position: absolute; top: 20px; left: 20px; background: #f56565; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .recording-dot { width: 12px; height: 12px; background: white; border-radius: 50%; animation: pulse 1s infinite; }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">üéØ</div>
            <h1>Evaluaci√≥n T√©cnica</h1>
            <p id="evaluationTitle">CoRheSelect - Gesti√≥n de Talento</p>
        </div>

        <!-- LOADING SCREEN -->
        <div id="loadingScreen">
            <div class="spinner"></div>
            <p>Cargando evaluaci√≥n...</p>
        </div>

        <!-- WELCOME SCREEN -->
        <div id="welcomeScreen" class="hidden">
            <h2>üëã Bienvenido/a a tu Evaluaci√≥n T√©cnica</h2>
            
            <div class="welcome-intro">
                <p>Esta prueba forma parte del proceso de selecci√≥n <strong id="jobTitle">Cargando...</strong> y tiene como objetivo evaluar tus conocimientos t√©cnicos.</p>
                <p>Lee cada pregunta con atenci√≥n y selecciona la respuesta correcta.</p>
            </div>

            <div class="privacy-notice">
                <h3>üîí Aviso de Privacidad y Grabaci√≥n</h3>
                <ul>
                    <li>Esta evaluaci√≥n puede incluir preguntas con respuestas en video</li>
                    <li>Se requerir√° acceso a tu c√°mara y micr√≥fono para grabar tus respuestas</li>
                    <li>Los videos ser√°n utilizados √∫nicamente para fines de evaluaci√≥n del proceso de selecci√≥n</li>
                    <li>Tus datos y respuestas ser√°n tratados de forma confidencial seg√∫n nuestra pol√≠tica de privacidad</li>
                    <li>Al continuar, aceptas el uso de tu c√°mara y la grabaci√≥n de videos como parte del proceso</li>
                </ul>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-icon">‚è±Ô∏è</div>
                    <div class="info-label">Tiempo estimado</div>
                    <div class="info-value" id="estimatedTime">20 minutos aproximadamente</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">üìù</div>
                    <div class="info-label">Formato</div>
                    <div class="info-value">Preguntas de opci√≥n m√∫ltiple y video</div>
                </div>
            </div>

            <div class="instructions">
                <h3>üìã Instrucciones importantes:</h3>
                <ul>
                    <li><strong>No puedes pausar</strong> la evaluaci√≥n una vez iniciada</li>
                    <li><strong>No puedes regresar</strong> a preguntas anteriores</li>
                    <li>Para preguntas de video: tendr√°s <strong>hasta 3 intentos</strong> para grabar tu mejor respuesta</li>
                    <li>Lee cuidadosamente cada pregunta antes de responder o grabar</li>
                    <li>Aseg√∫rate de estar en un lugar tranquilo con buena iluminaci√≥n para las grabaciones</li>
                    <li>Verifica que tu c√°mara y micr√≥fono funcionen correctamente</li>
                </ul>
            </div>

            <button class="start-button" onclick="startEvaluation()">Comenzar Evaluaci√≥n</button>
        </div>

        <!-- QUESTION SCREEN -->
        <div id="questionContainer" class="hidden">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="question-header">
                <span class="question-number" id="questionNumber">Pregunta 1 de 10</span>
                <span class="timer" id="timer">‚è±Ô∏è <span id="timeRemaining">00:00</span></span>
            </div>
            
            <div class="question-text" id="questionText"></div>
            
            <!-- Technical Question (Multiple Choice) -->
            <div id="technicalQuestion" class="hidden">
                <div class="options-container" id="optionsContainer"></div>
                <button class="next-button" id="nextButton" onclick="nextQuestion()" disabled>
                    Siguiente Pregunta ‚Üí
                </button>
            </div>
            
            <!-- Video Question -->
            <div id="videoQuestion" class="hidden">
                <div class="video-container">
                    <div class="attempt-indicator" id="attemptIndicator">Intento 1 de 3</div>
                    
                    <div class="video-info">
                        <p><strong>Instrucciones:</strong></p>
                        <p id="videoInstructions">T√≥mate tu tiempo para pensar tu respuesta. Cuando est√©s listo/a, presiona "Comenzar a grabar".</p>
                        <p>‚è±Ô∏è Tiempo m√°ximo de respuesta: <strong id="maxVideoTime">2:00</strong></p>
                    </div>
                    
                    <div class="video-preview" id="videoPreview">
                        <div class="video-placeholder" id="videoPlaceholder">
                            üìπ Presiona "Comenzar a grabar" cuando est√©s listo/a
                        </div>
                        <video id="videoElement" playsinline autoplay muted></video>
                        <video id="playbackElement" controls></video>
                    </div>
                    
                    <div class="video-controls">
                        <div class="button-group" id="videoButtons">
                            <button class="btn btn-primary" id="startRecordingBtn" onclick="startRecording()">
                                üî¥ Comenzar a grabar
                            </button>
                            <button class="btn btn-danger hidden" id="stopRecordingBtn" onclick="stopRecording()">
                                ‚èπÔ∏è Detener grabaci√≥n
                            </button>
                            <button class="btn btn-secondary hidden" id="retryRecordingBtn" onclick="retryRecording()">
                                üîÑ Volver a grabar
                            </button>
                            <button class="btn btn-success hidden" id="submitVideoBtn" onclick="submitVideo()">
                                ‚úÖ Enviar esta respuesta
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="resultsScreen" class="hidden">
            <div class="success-icon">‚úÖ</div>
            <h2 class="results-title">¬°Evaluaci√≥n Completada!</h2>
            <p class="results-message">
                Gracias por completar la evaluaci√≥n. Hemos recibido tus respuestas exitosamente.
                <br><br>
                Nos pondremos en contacto contigo pronto con los resultados.
            </p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ============================================
        
        const CONFIG = {
            AIRTABLE_API_KEY: 'pat5lEZUTWwxqfUOc.568d6970919313fa1fa0a5a37a2a30127518acafb18ea1529be5c1fa040fcd92',
            AIRTABLE_BASE_ID: 'appbcEo6nGgH5SeBp',
            CLOUDINARY_CLOUD_NAME: 'di5ulrlei',
            CLOUDINARY_UPLOAD_PRESET: 'evaluaciones-video',
            MINUTES_PER_QUESTION: 2
        };

        const TABLES = {
            EVALUATIONS: 'tblaMFH86OlzCp9dj',
            RESULTS: 'tbl3LOdaZaMfAGBxP',
            QUESTIONS: 'tbl8wHh68rNh4h1Zp',
            RESPONSES: 'tblILLpEJW4OxJugV'
        };

        let state = {
            evaluationId: null,
            candidateEmail: null,
            currentQuestionIndex: 0,
            questions: [],
            startTime: null,
            timeExpired: false,
            selectedAnswer: null,
            // Video recording state
            mediaRecorder: null,
            recordedChunks: [],
            currentAttempt: 1,
            maxAttempts: 3,
            currentVideoBlob: null,
            stream: null,
            recordingStartTime: null,
            maxRecordingTime: 120 // seconds
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                evaluationId: params.get('evaluation_id'),
                candidateEmail: params.get('email'),
                token: params.get('token')
            };
        }

        async function airtableRequest(table, recordId = '', method = 'GET', body = null) {
            const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${table}${recordId ? '/' + recordId : ''}`;
            
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`Airtable API error: ${response.statusText}`);
            }
            return await response.json();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            try {
                const params = getURLParams();
                
                if (!params.evaluationId || !params.token) {
                    throw new Error('Par√°metros de URL inv√°lidos');
                }
                
                state.evaluationId = params.evaluationId;
                state.candidateEmail = params.candidateEmail;
                
                // Cargar datos de la evaluaci√≥n
                await loadEvaluationData();
                
                // Mostrar pantalla de bienvenida
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
                alert('Error al cargar la evaluaci√≥n. Por favor, verifica el enlace.');
            }
        }

        async function loadEvaluationData() {
            try {
                // Obtener el resultado de evaluaci√≥n
                const resultData = await airtableRequest(TABLES.RESULTS, state.evaluationId);
                
                // Obtener el ID de la evaluaci√≥n vinculada
                const evaluationId = resultData.fields['Evaluaci√≥n']?.[0];
                
                if (!evaluationId) {
                    throw new Error('No hay evaluaci√≥n vinculada a este resultado');
                }
                
                // Cargar la evaluaci√≥n para obtener las preguntas
                const evaluationData = await airtableRequest(TABLES.EVALUATIONS, evaluationId);
                
                // Obtener las preguntas vinculadas
                const questionIds = evaluationData.fields['Preguntas de la evaluaci√≥n'];
                
                if (!questionIds || questionIds.length === 0) {
                    throw new Error('No hay preguntas asignadas a esta evaluaci√≥n');
                }
                
                // Cargar todas las preguntas
                const questionsPromises = questionIds.map(id => 
                    airtableRequest(TABLES.QUESTIONS, id)
                );
                
                const questionsData = await Promise.all(questionsPromises);
                state.questions = questionsData.map(q => {
                    // Limpiar opciones: remover letras a), b), c), d) y mantener solo el texto
                    let cleanOptions = [];
                    if (q.fields['Opciones de respuesta']) {
                        const rawOptions = q.fields['Opciones de respuesta'].split('\n');
                        cleanOptions = rawOptions.map(opt => {
                            // Remover "a) ", "b) ", etc. del inicio
                            return opt.replace(/^[a-d]\)\s*/i, '').trim();
                        }).filter(opt => opt.length > 0);
                    }
                    
                    return {
                        id: q.id,
                        text: q.fields['Pregunta'],
                        type: q.fields['Tipo de evaluaci√≥n'] || 'T√©cnica',
                        options: cleanOptions,
                        correctAnswer: q.fields['Respuesta correcta'],
                        maxVideoTime: q.fields['Tiempo m√°ximo de video (segundos)'] || 120,
                        maxAttempts: q.fields['Intentos permitidos'] || 3
                    };
                });
                
                // Actualizar UI con informaci√≥n de la evaluaci√≥n
                const jobTitle = evaluationData.fields['Nombre de la vacante']?.[0] || 'la vacante';
                document.getElementById('jobTitle').textContent = jobTitle;
                
                const totalMinutes = CONFIG.MINUTES_PER_QUESTION * state.questions.length;
                document.getElementById('estimatedTime').textContent = `${totalMinutes} minutos aproximadamente`;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                throw error;
            }
        }

        // ============================================
        // EVALUATION FLOW
        // ============================================
        
        function startEvaluation() {
            state.startTime = Date.now();
            state.currentQuestionIndex = 0;
            
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            
            showQuestion();
            startTimer();
        }

        function showQuestion() {
            const question = state.questions[state.currentQuestionIndex];
            state.selectedAnswer = null;
            
            // Update progress
            const progress = ((state.currentQuestionIndex + 1) / state.questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionNumber').textContent = 
                `Pregunta ${state.currentQuestionIndex + 1} de ${state.questions.length}`;
            
            // Show question text
            document.getElementById('questionText').textContent = question.text;
            
            // Show appropriate question type
            if (question.type === 'T√©cnica') {
                showTechnicalQuestion(question);
            } else {
                showVideoQuestion(question);
            }
        }

        function showTechnicalQuestion(question) {
            document.getElementById('technicalQuestion').classList.remove('hidden');
            document.getElementById('videoQuestion').classList.add('hidden');
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.onclick = () => selectOption(index);
                
                const letter = String.fromCharCode(65 + index);
                optionDiv.innerHTML = `
                    <input type="radio" class="option-radio" name="answer" id="option${index}">
                    <label class="option-text" for="option${index}"><strong>${letter}.</strong> ${option}</label>
                `;
                
                container.appendChild(optionDiv);
            });
            
            document.getElementById('nextButton').disabled = true;
        }

        function selectOption(index) {
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Select new option
            const options = document.querySelectorAll('.option');
            options[index].classList.add('selected');
            options[index].querySelector('input').checked = true;
            
            state.selectedAnswer = String.fromCharCode(65 + index);
            document.getElementById('nextButton').disabled = false;
        }

        async function nextQuestion() {
            const question = state.questions[state.currentQuestionIndex];
            
            // Save response
            await saveResponse(question, state.selectedAnswer, null);
            
            // Move to next question or finish
            state.currentQuestionIndex++;
            
            if (state.currentQuestionIndex < state.questions.length) {
                showQuestion();
            } else {
                finishEvaluation();
            }
        }

        // ============================================
        // VIDEO RECORDING FUNCTIONS
        // ============================================
        
        function showVideoQuestion(question) {
            document.getElementById('technicalQuestion').classList.add('hidden');
            document.getElementById('videoQuestion').classList.remove('hidden');
            
            // Reset video state
            state.currentAttempt = 1;
            state.maxAttempts = question.maxAttempts;
            state.maxRecordingTime = question.maxVideoTime;
            state.currentVideoBlob = null;
            
            // Update UI
            document.getElementById('attemptIndicator').textContent = `Intento 1 de ${state.maxAttempts}`;
            document.getElementById('maxVideoTime').textContent = formatTime(question.maxVideoTime);
            
            // Show initial buttons
            document.getElementById('startRecordingBtn').classList.remove('hidden');
            document.getElementById('stopRecordingBtn').classList.add('hidden');
            document.getElementById('retryRecordingBtn').classList.add('hidden');
            document.getElementById('submitVideoBtn').classList.add('hidden');
            
            // Show placeholder
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            document.getElementById('videoElement').classList.add('hidden');
            document.getElementById('playbackElement').classList.add('hidden');
        }

        async function startRecording() {
            try {
                // Request camera and microphone access
                state.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                // Show video preview
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = state.stream;
                videoElement.classList.remove('hidden');
                document.getElementById('videoPlaceholder').classList.add('hidden');
                document.getElementById('playbackElement').classList.add('hidden');
                
                // Setup MediaRecorder
                state.recordedChunks = [];
                state.mediaRecorder = new MediaRecorder(state.stream, {
                    mimeType: 'video/webm;codecs=vp9'
                });
                
                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.recordedChunks.push(event.data);
                    }
                };
                
                state.mediaRecorder.onstop = handleRecordingStop;
                
                // Start recording
                state.mediaRecorder.start();
                state.recordingStartTime = Date.now();
                
                // Update UI
                document.getElementById('startRecordingBtn').classList.add('hidden');
                document.getElementById('stopRecordingBtn').classList.remove('hidden');
                document.getElementById('videoInstructions').textContent = 
                    'üî¥ Grabando... Responde la pregunta con claridad.';
                
                // Auto-stop after max time
                setTimeout(() => {
                    if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                }, state.maxRecordingTime * 1000);
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                alert('No se pudo acceder a la c√°mara. Por favor, verifica los permisos.');
            }
        }

        function stopRecording() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
        }

        function handleRecordingStop() {
            // Stop camera stream
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
            }
            
            // Create blob from recorded chunks
            state.currentVideoBlob = new Blob(state.recordedChunks, { type: 'video/webm' });
            
            // Show playback
            const playbackElement = document.getElementById('playbackElement');
            playbackElement.src = URL.createObjectURL(state.currentVideoBlob);
            playbackElement.classList.remove('hidden');
            document.getElementById('videoElement').classList.add('hidden');
            
            // Calculate duration
            const duration = Math.floor((Date.now() - state.recordingStartTime) / 1000);
            
            // Update UI
            document.getElementById('stopRecordingBtn').classList.add('hidden');
            document.getElementById('submitVideoBtn').classList.remove('hidden');
            
            if (state.currentAttempt < state.maxAttempts) {
                document.getElementById('retryRecordingBtn').classList.remove('hidden');
            }
            
            document.getElementById('videoInstructions').innerHTML = 
                `‚úÖ Grabaci√≥n completada (${formatTime(duration)})<br>Revisa tu respuesta y decide si enviarla o grabar nuevamente.`;
        }

        function retryRecording() {
            state.currentAttempt++;
            
            if (state.currentAttempt > state.maxAttempts) {
                alert('Has alcanzado el n√∫mero m√°ximo de intentos.');
                return;
            }
            
            // Update attempt indicator
            document.getElementById('attemptIndicator').textContent = 
                `Intento ${state.currentAttempt} de ${state.maxAttempts}`;
            
            // Reset UI
            state.currentVideoBlob = null;
            document.getElementById('playbackElement').classList.add('hidden');
            document.getElementById('videoPlaceholder').classList.remove('hidden');
            document.getElementById('startRecordingBtn').classList.remove('hidden');
            document.getElementById('retryRecordingBtn').classList.add('hidden');
            document.getElementById('submitVideoBtn').classList.add('hidden');
            document.getElementById('videoInstructions').textContent = 
                'T√≥mate tu tiempo para pensar tu respuesta. Cuando est√©s listo/a, presiona "Comenzar a grabar".';
        }

        async function submitVideo() {
            if (!state.currentVideoBlob) {
                alert('No hay video para enviar.');
                return;
            }
            
            try {
                // Show loading state
                document.getElementById('submitVideoBtn').disabled = true;
                document.getElementById('submitVideoBtn').textContent = '‚è≥ Enviando...';
                
                const question = state.questions[state.currentQuestionIndex];
                
                // Upload video to Cloudinary
                const videoUrl = await uploadVideoToCloudinary(state.currentVideoBlob);
                
                // Save response with video URL
                await saveResponse(question, null, videoUrl);
                
                // Move to next question
                state.currentQuestionIndex++;
                
                if (state.currentQuestionIndex < state.questions.length) {
                    showQuestion();
                } else {
                    finishEvaluation();
                }
                
            } catch (error) {
                console.error('Error al enviar video:', error);
                alert('Error al enviar el video. Por favor, intenta nuevamente.');
                document.getElementById('submitVideoBtn').disabled = false;
                document.getElementById('submitVideoBtn').textContent = '‚úÖ Enviar esta respuesta';
            }
        }

        async function uploadVideoToCloudinary(blob) {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET);
            formData.append('folder', 'evaluaciones');
            
            const response = await fetch(
                `https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY_CLOUD_NAME}/video/upload`,
                {
                    method: 'POST',
                    body: formData
                }
            );
            
            if (!response.ok) {
                throw new Error('Error al subir video a Cloudinary');
            }
            
            const data = await response.json();
            return data.secure_url;
        }

        // ============================================
        // DATA PERSISTENCE
        // ============================================
        
        async function saveResponse(question, textAnswer, videoUrl) {
            try {
                const responseData = {
                    fields: {
                        '6. Resultados de evaluaciones por candidato 3': [state.evaluationId],
                        'Pregunta': [question.id],
                        'Respuesta del candidato eval t√©cnica/ingl√©s': textAnswer || '',
                        'N√∫mero de intentos': state.currentAttempt || 1
                    }
                };
                
                // Add video URL if it's a video question
                if (videoUrl) {
                    responseData.fields['Video respuesta'] = [{
                        url: videoUrl
                    }];
                    
                    // Calculate duration
                    const duration = Math.floor((Date.now() - state.recordingStartTime) / 1000);
                    responseData.fields['Duraci√≥n del video (segundos)'] = duration;
                    responseData.fields['Video final'] = true;
                }
                
                // Check if answer is correct (for technical questions)
                if (textAnswer && question.correctAnswer) {
                    const isCorrect = textAnswer === question.correctAnswer;
                    responseData.fields['Respuesta correcta'] = isCorrect ? 'S√≠' : 'No';
                }
                
                await airtableRequest(TABLES.RESPONSES, '', 'POST', responseData);
                
            } catch (error) {
                console.error('Error guardando respuesta:', error);
                throw error;
            }
        }

        async function finishEvaluation() {
            try {
                // Calculate score for technical questions
                const technicalQuestions = state.questions.filter(q => q.type === 'T√©cnica');
                
                // Update result record
                const updateData = {
                    fields: {
                        'Activo': false
                    }
                };
                
                await airtableRequest(TABLES.RESULTS, state.evaluationId, 'PATCH', updateData);
                
                // Show results screen
                document.getElementById('questionContainer').classList.add('hidden');
                document.getElementById('resultsScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error al finalizar evaluaci√≥n:', error);
                alert('Error al guardar resultados. Por favor, contacta al administrador.');
            }
        }

        // ============================================
        // TIMER
        // ============================================
        
        function startTimer() {
            const totalSeconds = CONFIG.MINUTES_PER_QUESTION * 60 * state.questions.length;
            let remainingSeconds = totalSeconds;
            
            const timerInterval = setInterval(() => {
                remainingSeconds--;
                
                document.getElementById('timeRemaining').textContent = formatTime(remainingSeconds);
                
                // Warning at 2 minutes
                if (remainingSeconds === 120) {
                    document.getElementById('timer').classList.add('timer-warning');
                }
                
                // Time's up
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    state.timeExpired = true;
                    alert('El tiempo ha terminado. La evaluaci√≥n se enviar√° autom√°ticamente.');
                    finishEvaluation();
                }
            }, 1000);
        }

        // ============================================
        // INITIALIZATION ON PAGE LOAD
        // ============================================
        
        window.addEventListener('DOMContentLoaded', init);
        
        // Prevent page refresh/close
        window.addEventListener('beforeunload', (e) => {
            if (state.currentQuestionIndex > 0 && state.currentQuestionIndex < state.questions.length) {
                e.preventDefault();
                e.returnValue = '¬øEst√°s seguro de que quieres salir? Tu progreso se perder√°.';
            }
        });
    </script>
</body>
</html>
